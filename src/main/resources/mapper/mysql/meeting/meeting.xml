<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pmp4.amoimproject.meeting.model.MeetingDAO">
    <insert id="insertMeeting" parameterType="meetingVo">
        insert into MEETING(user_no, title, content, category_code, person_number, dues)
        values (#{userNo}, #{title}, #{content}, #{categoryCode}, #{personNumber}, #{dues})

        <selectKey keyProperty="no" keyColumn="no" resultType="Long" order="AFTER">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <select id="selectByUserNoCard" parameterType="Long" resultType="hashMap">
        select
            m.NO,
            m.TITLE,
            (
                select i2.NAME
                from INTERESTS i2
                where i2.CATEGORY_CODE = i.CATEGORY_PARENT
            ) CATEGORY_PARENT,
                i.name CATEGORY_NAME,
            (
                select count(*)
                from USER_MEETING um
                where um.MEETING_NO = m.NO
            ) PERSON_COUNT,
                m.PERSON_NUMBER,
            (
                select JSON_ARRAYAGG(T.TAG_NAME) TAGS
                from MEETING_TAG M
                         join TAG T on T.TAG_NO = M.TAG_NO
                where MEETING_NO = m.NO
                group by MEETING_NO
            ) TAGS,
            m.DUES,
            (
                select count(*)
                from MEETING_LIKE ML
                where ML.MEETING_NO = m.NO
            ) LIKE_COUNT,
            MI.IMAGE_NAME,
            MA.SIGUNGU
        from
            MEETING m join INTERESTS I on I.CATEGORY_CODE = m.CATEGORY_CODE
                      join MEETING_ADDRESS MA on m.NO = MA.MEETING_NO
                      join MEETING_IMAGES MI on m.NO = MI.MEETING_NO
        where USER_NO = #{userNo} and DEL_TAG = 'N' and MI.SEQ = 1
    </select>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <resultMap id="meetingViewMap" type="hashMap">
        <association property="CONTENTS" column="no" javaType="hashMap">
            <id column="NO" jdbcType="BIGINT" property="NO"/>
            <result column="USERS_NO" jdbcType="BIGINT" property="USERS_NO"/>
            <result column="TITLE" jdbcType="VARCHAR" property="TITLE"/>
            <result column="CONTENT" jdbcType="VARCHAR" property="CONTENT"/>
            <result column="CATEGORY_PARENT" jdbcType="VARCHAR" property="CATEGORY_PARENT"/>
            <result column="CATEGORY_CODE" jdbcType="VARCHAR" property="CATEGORY_CODE"/>
            <result column="CATEGORY_PARENT_NAME" jdbcType="VARCHAR" property="CATEGORY_PARENT_NAME"/>
            <result column="CATEGORY_NAME" jdbcType="VARCHAR" property="CATEGORY_NAME"/>
            <result column="TAGS" jdbcType="VARCHAR" property="TAGS"/>
            <result column="IMAGE_NAME" jdbcType="VARCHAR" property="IMAGE_NAME"/>
            <result column="ADDRESS_NO" jdbcType="BIGINT" property="ADDRESS_NO"/>
            <result column="ADDRESS" jdbcType="VARCHAR" property="ADDRESS"/>
            <result column="ROAD_ADDRESS" jdbcType="VARCHAR" property="ROAD_ADDRESS"/>
            <result column="JIBUN_ADDRESS" jdbcType="VARCHAR" property="JIBUN_ADDRESS"/>
            <result column="PLACE_NAME" jdbcType="VARCHAR" property="PLACE_NAME"/>
            <result column="LIKE_COUNT" jdbcType="BIGINT" property="LIKE_COUNT"/>
            <result column="PERSON_NUMBER" jdbcType="BIGINT" property="PERSON_NUMBER"/>
            <result column="PERSON_COUNT" jdbcType="BIGINT" property="PERSON_COUNT"/>
        </association>
        <collection property="MEMBERS" column="NO" javaType="ArrayList" ofType="hashMap" select="selectUserMeeting">

        </collection>
    </resultMap>

    <select id="selectUserMeeting" parameterType="String" resultType="hashMap">
        select * from USER_MEETING where MEETING_NO = #{no}
    </select>
    
    
    <select id="selectByNo" parameterType="String" resultMap="meetingViewMap">
        select
            M.NO,
            M.USER_NO,
            M.TITLE,
            M.CONTENT,
            I.CATEGORY_PARENT,
            M.CATEGORY_CODE,
            (
                select NAME
                from INTERESTS I2
                where I2.CATEGORY_CODE = I.CATEGORY_PARENT
            ) CATEGORY_PARENT_NAME,
            I.NAME CATEGORY_NAME,
            (
                select JSON_ARRAYAGG(T.TAG_NAME)
                from MEETING_TAG MT join TAG T on T.TAG_NO = MT.TAG_NO
                where MT.MEETING_NO = M.NO
                group by MT.MEETING_NO
            ) TAGS,
            MI.IMAGE_NAME,
            MA.ADDRESS_NO,
            MA.ADDRESS,
            MA.ROAD_ADDRESS,
            MA.JIBUN_ADDRESS,
            MA.PLACE_NAME,
            (
                select count(*)
                from MEETING_LIKE ML
                where ML.MEETING_NO = M.NO
            ) LIKE_COUNT,
            M.PERSON_NUMBER,
            (
                select count(*)
                from USER_MEETING um
                where um.MEETING_NO = m.NO
            ) PERSON_COUNT
        from MEETING M join INTERESTS I on I.CATEGORY_CODE = M.CATEGORY_CODE
                       join MEETING_IMAGES MI on M.NO = MI.MEETING_NO
                       join MEETING_ADDRESS MA on M.NO = MA.MEETING_NO
        where M.NO = #{no} and DEL_TAG = 'N'
    </select>

    <select id="selectByUserCount" parameterType="String" resultType="int">
        select count(*) from MEETING where USER_NO = #{userNo}
    </select>
</mapper>